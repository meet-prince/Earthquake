Import React, { useState, useEffect, useRef } from 'react';
import { Activity, Bluetooth, ArrowLeft, Flashlight, Info, ShieldCheck, Volume2, VolumeX, Phone, Zap } from 'lucide-react';

// --- Types & Constants ---
type ScreenType = 'SPLASH' | 'DASHBOARD' | 'INTENSITY' | 'GRAPH' | 'EMERGENCY';
type StatusLevel = 'SAFE' | 'MILD' | 'STRONG' | 'DANGER';

const THRESHOLDS = {
  SAFE: 20,
  MILD: 50,
  STRONG: 120,
};

// --- Advanced Audio Engine (Unchanged for logic) ---
class SoundManager {
  private ctx: AudioContext | null = null;
  private masterGain: GainNode | null = null;
  
  // Siren Nodes
  private sirenOsc: OscillatorNode | null = null;
  private sirenLfo: OscillatorNode | null = null;
  private sirenGain: GainNode | null = null;
  
  // Beep State
  private beepTimer: number | null = null;
  private isBeeping: boolean = false;

  init() {
    if (!this.ctx) {
      // @ts-ignore
      const AudioContextClass = window.AudioContext || window.webkitAudioContext;
      this.ctx = new AudioContextClass();
      this.masterGain = this.ctx.createGain();
      this.masterGain.connect(this.ctx.destination);
    }
  }

  async resume() {
    if (this.ctx && this.ctx.state === 'suspended') {
      await this.ctx.resume();
    }
  }

  // MODE 1: Standard "Wee-Woo" Siren
  startSiren() {
    this.stopBeep();
    if (this.sirenOsc) return;

    if (!this.ctx || !this.masterGain) this.init();
    this.resume();

    const t = this.ctx!.currentTime;

    this.sirenOsc = this.ctx!.createOscillator();
    this.sirenLfo = this.ctx!.createOscillator();
    this.sirenGain = this.ctx!.createGain();
    const lfoGain = this.ctx!.createGain();

    this.sirenOsc.type = 'sawtooth'; 
    this.sirenOsc.frequency.value = 600; 

    this.sirenLfo.type = 'sine';
    this.sirenLfo.frequency.value = 0.5;
    lfoGain.gain.value = 200;

    // Wiring
    this.sirenLfo.connect(lfoGain);
    lfoGain.connect(this.sirenOsc.frequency);
    this.sirenOsc.connect(this.sirenGain);
    this.sirenGain.connect(this.masterGain!);

    // Fade in
    this.sirenGain.gain.setValueAtTime(0, t);
    this.sirenGain.gain.linearRampToValueAtTime(0.3, t + 0.5);

    this.sirenOsc.start(t);
    this.sirenLfo.start(t);
  }

  stopSiren() {
    if (this.sirenOsc) {
      const t = this.ctx!.currentTime;
      
      this.sirenGain?.gain.setValueAtTime(this.sirenGain.gain.value, t);
      this.sirenGain?.gain.linearRampToValueAtTime(0.0001, t + 0.05);

      setTimeout(() => {
        if (this.sirenOsc) {
          try {
            this.sirenOsc.stop();
            this.sirenLfo?.stop();
            this.sirenOsc.disconnect();
            this.sirenLfo?.disconnect();
          } catch (e) { /* ignore already stopped error */ }
        }
        this.sirenOsc = null;
        this.sirenLfo = null;
      }, 70); 
    }
  }

  // MODE 2: Warning Beeps
  startBeep() {
    this.stopSiren();
    if (this.isBeeping) return;
    
    if (!this.ctx || !this.masterGain) this.init();
    this.resume();
    
    this.isBeeping = true;
    this.beepLoop();
  }

  private beepLoop() {
    if (!this.isBeeping || !this.ctx) return;
    
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();

    osc.type = 'square';
    osc.frequency.setValueAtTime(800, t); 
    
    osc.connect(gain);
    gain.connect(this.masterGain!);

    gain.gain.setValueAtTime(0.1, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);

    osc.start(t);
    osc.stop(t + 0.2);

    this.beepTimer = window.setTimeout(() => this.beepLoop(), 800);
  }

  stopBeep() {
    this.isBeeping = false;
    if (this.beepTimer) {
      clearTimeout(this.beepTimer);
      this.beepTimer = null;
    }
  }

  stopAll() {
    this.stopSiren();
    this.stopBeep();
  }
}

const soundManager = new SoundManager();


// --- Helper Components ---
const LiveGraph = ({ data }: { data: number[] }) => {
  const height = 150;
  const width = 300;
  const maxVal = 200;

  const points = data.map((val, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - (val / maxVal) * height;
    return `${x},${y}`;
  }).join(' ');

  return (
    <div className="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
      <h3 className="text-gray-400 text-xs mb-2 font-mono">LIVE SEISMIC DATA (Past 20 points)</h3>
      <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} className="overflow-visible">
        <line x1="0" y1={height * 0.25} x2={width} y2={height * 0.25} stroke="#374151" strokeDasharray="4" />
        <line x1="0" y1={height * 0.5} x2={width} y2={height * 0.5} stroke="#374151" strokeDasharray="4" />
        <polyline fill="none" stroke="#22c55e" strokeWidth="2" points={points} />
        <polygon fill="rgba(34, 197, 94, 0.1)" stroke="none" points={`0,${height} ${points} ${width},${height}`} />
      </svg>
    </div>
  );
};

export default function EarthquakeApp() {
  const [currentScreen, setCurrentScreen] = useState<ScreenType>('SPLASH');
  const [sensorValue, setSensorValue] = useState(0);
  const [isConnected, setIsConnected] = useState(false);
  const [history, setHistory] = useState<number[]>(new Array(20).fill(0));
  const [flashOn, setFlashOn] = useState(false);
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  // --- Simulation Logic ---
  useEffect(() => {
    if (currentScreen === 'SPLASH') {
      const timer = setTimeout(() => setCurrentScreen('DASHBOARD'), 2000); // Faster splash
      return () => clearTimeout(timer);
    }
  }, [currentScreen]);

  useEffect(() => {
    const interval = setInterval(() => {
      if (isConnected) {
        setHistory(prev => [...prev.slice(1), sensorValue]);
      }
    }, 500);
    return () => clearInterval(interval);
  }, [sensorValue, isConnected]);

  const getStatus = (val: number): StatusLevel => {
    if (val <= THRESHOLDS.SAFE) return 'SAFE';
    if (val <= THRESHOLDS.MILD) return 'MILD';
    if (val <= THRESHOLDS.STRONG) return 'STRONG';
    return 'DANGER';
  };

  const status = getStatus(sensorValue);

  // --- AUDIO LOGIC CONTROLLER ---
  useEffect(() => {
    if (!isConnected || !soundEnabled) {
      soundManager.stopAll();
      return;
    }

    switch (status) {
      case 'DANGER':
        soundManager.startSiren();
        break;
      case 'STRONG':
        soundManager.startBeep();
        break;
      default: // SAFE and MILD
        soundManager.stopAll();
        break;
    }
  }, [status, isConnected, soundEnabled]);


  // Colors based on status
  const getThemeColorClass = (type: 'bg' | 'text' | 'ring') => {
    switch (status) {
      case 'SAFE': return type === 'bg' ? 'bg-green-600' : type === 'text' ? 'text-green-600' : 'ring-green-400';
      case 'MILD': return type === 'bg' ? 'bg-yellow-500' : type === 'text' ? 'text-yellow-500' : 'ring-yellow-400';
      case 'STRONG': return type === 'bg' ? 'bg-orange-600' : type === 'text' ? 'text-orange-600' : 'ring-orange-400';
      case 'DANGER': return type === 'bg' ? 'bg-red-700 animate-pulse' : type === 'text' ? 'text-red-600' : 'ring-red-400';
      default: return type === 'bg' ? 'bg-gray-400' : type === 'text' ? 'text-gray-400' : 'ring-gray-300';
    }
  };

  const handleConnect = () => {
    soundManager.init(); 
    setIsConnected(!isConnected);
  };

  // --- Main Screen Switcher Logic ---
  useEffect(() => {
    // Open Emergency on STRONG or DANGER (sensorValue > 50)
    if (isConnected && sensorValue > THRESHOLDS.MILD && currentScreen !== 'EMERGENCY') {
        setCurrentScreen('EMERGENCY');
    }
    // Close Emergency if it drops back to MILD or SAFE (sensorValue <= 50)
    if (isConnected && sensorValue <= THRESHOLDS.MILD && currentScreen === 'EMERGENCY') {
        setCurrentScreen('DASHBOARD');
    }
  }, [sensorValue, isConnected]);


  // --- Screens ---

  const renderSplash = () => (
    <div className="h-full flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center">
      <div className="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center mb-6 animate-pulse">
        <Zap size={48} className="text-white"/>
      </div>
      <h1 className="text-4xl font-extrabold mb-2 tracking-wide">SHAKE ALERT</h1>
      <p className="text-gray-400 font-light text-lg">Seismic Monitoring Interface</p>
    </div>
  );

  const renderDashboard = () => (
    <div className="h-full flex flex-col bg-gray-50">
      {/* Header */}
      <div className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg">
        <span className="font-bold text-xl flex items-center gap-2 tracking-wider">
            <Activity size={24} className="text-blue-400"/> Monitor
        </span>
        <div className={`px-3 py-1 rounded-full text-xs font-semibold shadow-md ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}>
          {isConnected ? 'LIVE' : 'OFFLINE'}
        </div>
      </div>

      <div className="flex-1 p-6 flex flex-col items-center justify-center gap-10">
        {/* Status Display Circle */}
        <div className={`
            w-64 h-64 rounded-full p-2 border-4 border-gray-200 
            flex items-center justify-center shadow-xl transition-all duration-300
        `}>
          <div className={`
            w-full h-full rounded-full flex flex-col items-center justify-center text-white 
            ring-8 ${getThemeColorClass('ring')} ring-opacity-30 transition-colors duration-500 shadow-inner 
            ${isConnected ? getThemeColorClass('bg') : 'bg-gray-400'}
          `}>
            <span className="text-7xl font-extrabold leading-none">{isConnected ? sensorValue : '--'}</span>
            <span className="text-sm uppercase mt-3 tracking-widest font-semibold">
              {isConnected ? status : 'OFFLINE'}
            </span>
          </div>
        </div>

        <div className="text-center">
          <h2 className="text-2xl font-bold text-slate-800">System Status</h2>
          <p className="text-slate-500 font-light mt-1">
            {isConnected ? `Monitoring active. Level: ${status}` : `Sensor connection required.`}
          </p>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-2 gap-4 w-full max-w-xs">
          <button 
            onClick={handleConnect}
            className={`flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-white shadow-lg transition-transform hover:shadow-xl active:scale-95 ${isConnected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
          >
            <Bluetooth size={20} />
            {isConnected ? 'Disconnect' : 'Connect'}
          </button>
          
          <button 
            onClick={() => setCurrentScreen('GRAPH')}
            className="flex items-center justify-center gap-2 py-3 bg-slate-700 hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg transition-transform hover:shadow-xl active:scale-95"
            disabled={!isConnected}
          >
            <Activity size={20} />
            Wave Graph
          </button>
        </div>

        <button onClick={() => setCurrentScreen('INTENSITY')} className="text-blue-600 font-medium text-sm mt-2 hover:text-blue-800 transition-colors">
          View Intensity Scale
        </button>
      </div>
    </div>
  );

  const renderIntensity = () => (
    <div className="h-full flex flex-col bg-white">
       <div className="bg-slate-900 text-white p-4 flex items-center gap-4 shadow-md">
        <button onClick={() => setCurrentScreen('DASHBOARD')} className="p-1 rounded-full hover:bg-slate-700 transition-colors"><ArrowLeft /></button>
        <span className="font-bold text-xl">Intensity Guide</span>
      </div>
      <div className="p-6 flex flex-col gap-4 overflow-y-auto">
        <div className="bg-green-50 p-4 rounded-xl border-l-4 border-green-500 shadow-sm">
          <h3 className="font-bold text-green-800">0 - 20: SAFE</h3>
          <p className="text-sm text-gray-600">No activity detected. System is silent.</p>
        </div>
        <div className="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-500 shadow-sm">
          <h3 className="font-bold text-yellow-800">21 - 50: MILD</h3>
          <p className="text-sm text-gray-600">Minor ground tremors. Stays on Dashboard.</p>
        </div>
        <div className="bg-orange-50 p-4 rounded-xl border-l-4 border-orange-500 shadow-lg">
          <h3 className="font-bold text-orange-800">51 - 120: STRONG (WARNING)</h3>
          <p className="text-sm text-gray-700">**Auto-switch to Emergency Screen.** Beeping Alert active.</p>
        </div>
        <div className="bg-red-50 p-4 rounded-xl border-l-4 border-red-600 shadow-lg animate-pulse">
          <h3 className="font-bold text-red-900">120+: DANGER (EVACUATE)</h3>
          <p className="text-sm text-gray-700">**Auto-switch to Emergency Screen.** Continuous Siren active.</p>
        </div>
      </div>
    </div>
  );

  const renderGraph = () => (
    <div className="h-full flex flex-col bg-slate-900 text-white">
      <div className="bg-slate-800 p-4 flex items-center gap-4 shadow-md border-b border-slate-700">
        <button onClick={() => setCurrentScreen('DASHBOARD')} className="p-1 rounded-full hover:bg-slate-700 transition-colors"><ArrowLeft /></button>
        <span className="font-bold text-xl">Seismograph History</span>
      </div>
      <div className="flex-1 p-4 flex flex-col items-center justify-center">
        <LiveGraph data={history} />
        <div className="mt-6 text-center text-gray-400 text-sm font-light">Last 10 seconds of recorded data</div>
      </div>
    </div>
  );

  const renderEmergency = () => (
    <div className="h-full flex flex-col bg-red-900 text-white relative overflow-hidden">
      {/* Background Pulse Effect */}
      <div className="absolute inset-0 bg-red-800 opacity-50 animate-pulse" style={{animationDuration: '2s'}}></div>
      
      <div className="relative z-10 flex flex-col h-full p-6">
        {/* Top Bar */}
        <div className="flex items-center justify-between mb-8">
            <button onClick={() => setCurrentScreen('DASHBOARD')} className="bg-red-700 p-2 rounded-full shadow-md hover:bg-red-600"><ArrowLeft size={20}/></button>
            <h1 className="text-3xl font-black tracking-widest text-yellow-300">ALERT!</h1>
            <button onClick={() => setSoundEnabled(!soundEnabled)} className="bg-red-700 p-2 rounded-full shadow-md hover:bg-red-600">
               {soundEnabled ? <Volume2 size={24} className="animate-pulse"/> : <VolumeX size={24}/>}
            </button>
        </div>

        {/* Content */}
        <div className="flex-1 flex flex-col items-center text-center gap-6">
            {/* Value Indicator */}
            <div className="bg-yellow-300 text-red-900 px-8 py-3 rounded-full font-black text-2xl shadow-xl border-4 border-red-900">
                MAGNITUDE: {sensorValue}
            </div>
            
            {/* Protocol Box */}
            <div className="bg-red-700 p-6 rounded-xl w-full shadow-2xl border-2 border-red-500">
                <h3 className="text-xl font-extrabold mb-4 border-b border-red-500 pb-2 text-yellow-200">SAFETY PROTOCOL</h3>
                <ul className="text-left space-y-3 font-medium text-gray-100">
                    <li className="flex items-center gap-2"><ShieldCheck size={20} className='text-yellow-300'/> DROP, COVER, HOLD ON immediately.</li>
                    <li className="flex items-center gap-2"><ShieldCheck size={20} className='text-yellow-300'/> AVOID windows, glass, and heavy furniture.</li>
                </ul>
            </div>
            
            {/* SOS Button */}
            <button className="w-full bg-yellow-400 text-red-900 font-black text-2xl py-5 rounded-xl shadow-2xl flex items-center justify-center gap-3 transition-transform active:scale-95 hover:bg-yellow-300">
                <Phone size={28} className="animate-pulse"/> CALL EMERGENCY SERVICES
            </button>
            
            {/* Flashlight Button */}
            <button 
                onClick={() => setFlashOn(!flashOn)}
                className={`w-full py-4 rounded-xl font-black text-xl flex items-center justify-center gap-2 shadow-xl transition-all active:scale-95 ${flashOn ? 'bg-white text-red-900' : 'bg-red-800 text-gray-200 border-2 border-red-500'}`}
            >
                <Flashlight size={24} />
                {flashOn ? 'FLASHLIGHT ACTIVATED' : 'ACTIVATE FLASHLIGHT'}
            </button>
        </div>
      </div>
    </div>
  );

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4 font-inter">
        {/* PHONE FRAME */}
        <div className="relative w-[360px] h-[720px] bg-black rounded-[3rem] shadow-2xl border-[10px] border-gray-900 overflow-hidden">
            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-gray-900 rounded-b-xl z-50"></div>
            <div className="w-full h-full bg-white overflow-hidden relative">
                {currentScreen === 'SPLASH' && renderSplash()}
                {currentScreen === 'DASHBOARD' && renderDashboard()}
                {currentScreen === 'INTENSITY' && renderIntensity()}
                {currentScreen === 'GRAPH' && renderGraph()}
                {currentScreen === 'EMERGENCY' && renderEmergency()}
            </div>
        </div>

        {/* CONTROLS */}
        <div className="mt-8 bg-white p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-200">
            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2 text-lg">
                <Zap size={20} className='text-blue-500'/> Sensor Simulation Controls
            </h3>
            
            <div className="space-y-4">
                <div>
                    <div className="flex justify-between text-sm mb-2 font-semibold">
                        <span className="text-gray-800">Vibration Intensity:</span>
                        <span className={`font-bold ${getThemeColorClass('text')}`}>{sensorValue}</span>
                    </div>
                    <input 
                        type="range" min="0" max="200" value={sensorValue} 
                        onChange={(e) => setSensorValue(parseInt(e.target.value))}
                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 transition-colors"
                    />
                </div>

                <div className="flex justify-around gap-2 pt-2 border-t border-gray-100">
                    <button onClick={() => setSensorValue(15)} className="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg font-medium hover:bg-green-200 transition-colors">SAFE (15)</button>
                    <button onClick={() => setSensorValue(60)} className="px-4 py-2 text-sm bg-orange-100 text-orange-700 rounded-lg font-medium hover:bg-orange-200 transition-colors">WARNING (60)</button>
                    <button onClick={() => setSensorValue(150)} className="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg font-medium hover:bg-red-200 transition-colors">DANGER (150)</button>
                </div>
                <p className="text-xs text-gray-500 mt-2 text-center">**Warning threshold is 51. Danger threshold is 121.**</p>
            </div>
        </div>
    </div>
  );
}